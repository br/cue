#!/bin/bash

function prompt-shell {
  echo " $SHLVL:$HISTCMD"
}

function prompt-error {
  # optional error
  local err_last="$?"
  if [[ -n $err_last && $err_last != 0 ]]; then
    echo " ${sorange}[${sred}$err_last${sorange}]"
  fi
}

function prompt-filler {
  local prn_prompt="$1"; shift
  # filler
  if [[ -z $COLUMNS ]]; then
    eval $(resize)
  fi

  local len_prompt=$(echo -n "$prn_prompt" | perl -pe 's{\e\[\d+;\d+m}{}g' | wc -c | tr -d " ")
  local txt_fill=" "
  for _ in $(eval echo {1..$((COLUMNS - len_prompt - 1))}); do
    txt_fill="${txt_fill}-"
  done
  echo "${scomment}${txt_fill}"
}

function prompt {
  local prompts="$(echo "${PS1_LEFT}${PS1_RIGHT}" | sed 's#${prn_##g; s#}# #g')"
  local p
  for p in $prompts; do
    fn_prn="prompt-${p}"
    nm_prn="prn_${p}"
    eval "$nm_prn=\$($fn_prn)"
  done

  prn_shell="$(prompt-shell)"
  prn_error="$(prompt-error)"
  prn_filler="$(prompt-filler "$(eval echo "--${PS1_LEFT}${PS1_RIGHT} --")")"
}

PROMPT_COMMAND=prompt

# vim: ts=2 sw=2 et
